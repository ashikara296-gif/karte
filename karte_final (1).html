<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title id="pageTitle">ã‚«ãƒ«ãƒ†ã‚·ã‚¹ãƒ†ãƒ </title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
/* =====================================================
   â–¼â–¼â–¼ ä¸‹éƒ¨ã®CONFIGã§é™¢åãƒ»æ‹…å½“è€…åã‚’å¤‰æ›´ã§ãã¾ã™ â–¼â–¼â–¼
===================================================== */
:root{
  --ink:#1c1510;--ink-mid:#4a3c2e;--ink-soft:#7a6a58;
  --cream:#faf5ec;--cream-2:#f2ead8;--cream-3:#e8dfc9;
  --gold:#b8935a;--gold-light:#d4b07a;--gold-pale:#f0e0c0;
  --teal:#2d6a6a;--teal-light:#4a9090;
  --red:#b03030;--green:#2a7a4a;
  --border:#d4c4a0;--border-light:#e8dcc4;
  --shadow-sm:0 2px 8px rgba(60,40,10,.10);
  --shadow-md:0 4px 20px rgba(60,40,10,.14);
  --shadow-lg:0 8px 40px rgba(60,40,10,.18);
  --radius:6px;--tr:.22s cubic-bezier(.4,0,.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px}
body{font-family:'Noto Sans JP',sans-serif;background:var(--cream-3);color:var(--ink);min-height:100vh;-webkit-font-smoothing:antialiased}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeUp .4s ease both}

/* HEADER */
.top-header{position:sticky;top:0;z-index:100;background:var(--ink);border-bottom:2px solid var(--gold);display:flex;align-items:center;justify-content:space-between;padding:0 16px;height:52px}
.header-logo{font-family:'Noto Serif JP',serif;font-size:1rem;letter-spacing:.15em;color:var(--cream);white-space:nowrap}
.header-logo em{color:var(--gold);font-style:normal}
.header-right{display:flex;align-items:center;gap:12px}
.header-staff{font-size:.7rem;color:var(--gold-pale);letter-spacing:.08em;display:none}
.hamburger{display:flex;flex-direction:column;gap:5px;background:none;border:none;cursor:pointer;padding:4px}
.hamburger span{display:block;width:22px;height:1.5px;background:var(--gold-light)}

/* LAYOUT */
.app-layout{display:flex;max-width:1280px;margin:0 auto;min-height:calc(100vh - 52px)}

/* SIDEBAR */
.sidebar{width:260px;flex-shrink:0;background:var(--cream);border-right:1px solid var(--border);display:flex;flex-direction:column;transition:transform var(--tr);overflow-y:auto}
.sidebar-inner{padding:18px 13px;display:flex;flex-direction:column;gap:18px}
.sidebar-label{font-size:.62rem;letter-spacing:.22em;color:var(--gold);text-transform:uppercase;padding-bottom:6px;border-bottom:1px solid var(--border);margin-bottom:4px}
.patient-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border:1px solid var(--border-light);border-radius:var(--radius);cursor:pointer;transition:var(--tr);background:var(--cream)}
.patient-item:hover{background:#fff8ee;border-color:var(--gold-light)}
.patient-item.active{background:linear-gradient(135deg,#fff8ee,#fdf0d8);border-color:var(--gold);box-shadow:var(--shadow-sm)}
.patient-avatar{width:34px;height:34px;border-radius:50%;background:var(--ink);color:var(--gold);font-family:'Noto Serif JP',serif;font-size:.76rem;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.patient-item.active .patient-avatar{background:var(--gold);color:var(--ink)}
.p-name{font-size:.85rem;font-weight:500;color:var(--ink)}
.p-meta{font-size:.67rem;color:var(--ink-soft);margin-top:1px}
.new-btn{width:100%;padding:9px;background:var(--teal);color:#e0f2f2;border:none;font-family:'Noto Sans JP',sans-serif;font-size:.75rem;letter-spacing:.1em;cursor:pointer;border-radius:var(--radius);transition:var(--tr);margin-top:4px}
.new-btn:hover{background:var(--teal-light)}
.history-list{display:flex;flex-direction:column}
.history-row{display:flex;justify-content:space-between;font-size:.7rem;color:var(--ink-mid);padding:5px 4px;border-bottom:1px solid var(--border-light)}
.history-row:last-child{border-bottom:none}
.visit-n{color:var(--gold)}

/* MAIN */
.main-area{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--cream-2)}
.karte-scroll{flex:1;overflow-y:auto;padding:20px 16px}

/* KARTE CARD */
.karte-card{background:white;border:1.5px solid var(--border);max-width:820px;margin:0 auto;box-shadow:var(--shadow-md);border-radius:4px;overflow:hidden}
.karte-top{background:var(--ink);padding:13px 18px;display:flex;align-items:center;justify-content:space-between}
.karte-tag{font-size:.56rem;letter-spacing:.3em;color:var(--gold);text-transform:uppercase;margin-bottom:3px}
.karte-salon{font-family:'Noto Serif JP',serif;font-size:1rem;letter-spacing:.15em;color:var(--cream)}
.karte-top-right{text-align:right}
.karte-no{font-size:.7rem;color:var(--gold-light)}
.karte-date{font-size:.66rem;color:rgba(245,240,232,.6);margin-top:2px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;border-bottom:1.5px solid var(--border)}
.info-col{border-right:1px solid var(--border)}
.info-col:last-child{border-right:none}
.info-row{display:grid;grid-template-columns:80px 1fr;border-bottom:1px solid var(--border-light);min-height:32px}
.info-row:last-child{border-bottom:none}
.lbl{background:#f8f0e0;font-size:.63rem;letter-spacing:.08em;color:var(--gold);padding:0 8px;display:flex;align-items:center;border-right:1px solid var(--border)}
.val{font-size:.78rem;padding:5px 10px;color:var(--ink);display:flex;align-items:center}
.val.name-val{font-family:'Noto Serif JP',serif;font-size:.96rem;font-weight:600}
.karte-section{border-bottom:1px solid var(--border-light)}
.section-head{background:#f8f2e4;padding:5px 14px;font-family:'Noto Serif JP',serif;font-size:.67rem;letter-spacing:.18em;color:var(--gold);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px}
.section-head::before{content:'';width:3px;height:10px;background:var(--gold);flex-shrink:0}
.sec-body{padding:10px 14px;font-size:.78rem;color:var(--ink);line-height:1.85}
.body-area{display:flex;gap:14px;padding:12px 14px;align-items:flex-start}
.body-svg-wrap{flex-shrink:0;width:90px}
.body-svg-wrap svg{width:100%}
.pain-info{flex:1}
.pain-tag{display:inline-block;background:#fff0ee;border:1px solid #e8a090;color:var(--red);font-size:.65rem;padding:2px 7px;border-radius:2px;margin:2px}
.pain-detail{margin-top:9px;font-size:.7rem;color:var(--ink-mid);line-height:1.9}
.visit-box{margin:0 14px 12px;border:1px solid var(--border);border-radius:3px;overflow:hidden;background:#fffdf8}
.visit-head{background:var(--ink);color:var(--gold-pale);padding:5px 12px;font-size:.65rem;letter-spacing:.12em;display:flex;justify-content:space-between}
.visit-body{padding:9px 12px}
.vrow{display:flex;gap:8px;margin-bottom:5px;font-size:.75rem}
.vlbl{font-size:.63rem;color:var(--gold);letter-spacing:.08em;flex-shrink:0;padding-top:2px;min-width:68px}
.no-record{padding:28px 16px;text-align:center;color:var(--ink-soft);font-size:.78rem;line-height:2}

/* VOICE PANEL */
.voice-panel{background:var(--ink);border-top:2px solid var(--gold);padding:12px 14px}
.voice-panel-inner{display:flex;gap:10px;align-items:flex-end;max-width:820px;margin:0 auto}
.mic-wrap{display:flex;flex-direction:column;align-items:center;gap:5px;flex-shrink:0}
.mic-btn{width:50px;height:50px;border-radius:50%;background:var(--gold);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--tr)}
.mic-btn svg{width:21px;height:21px;fill:var(--ink)}
.mic-btn.rec{background:var(--red);animation:pulse 1.2s infinite}
.mic-btn.rec svg{fill:white}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(176,48,48,.5)}70%{box-shadow:0 0 0 14px rgba(176,48,48,0)}100%{box-shadow:0 0 0 0 rgba(176,48,48,0)}}
.mic-label{font-size:.6rem;color:rgba(245,240,232,.5);letter-spacing:.07em;white-space:nowrap}
.voice-input-area{flex:1;min-width:0}
.voice-textarea{width:100%;background:rgba(255,255,255,.07);border:1px solid rgba(184,147,90,.35);border-radius:var(--radius);padding:9px 11px;color:var(--cream);font-family:'Noto Sans JP',sans-serif;font-size:.78rem;line-height:1.7;min-height:50px;max-height:90px;resize:none;outline:none}
.voice-textarea::placeholder{color:rgba(245,240,232,.28);font-size:.72rem}
.voice-hint{font-size:.6rem;color:rgba(245,240,232,.32);margin-top:4px}
.voice-btns{display:flex;flex-direction:column;gap:6px;flex-shrink:0}
.vbtn{padding:8px 13px;border:none;border-radius:4px;font-family:'Noto Sans JP',sans-serif;font-size:.68rem;letter-spacing:.09em;cursor:pointer;transition:var(--tr);white-space:nowrap;font-weight:500}
.vbtn-parse{background:var(--gold);color:var(--ink)}
.vbtn-parse:hover{background:var(--gold-light)}
.vbtn-save{background:var(--green);color:white}
.vbtn-save:hover{background:#359958}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(20,14,8,.6);align-items:center;justify-content:center;padding:16px}
.modal-overlay.open{display:flex}
.modal{background:white;border-radius:var(--radius);width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:fadeUp .3s ease}
.modal-head{background:var(--ink);color:var(--gold-pale);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;font-family:'Noto Serif JP',serif;font-size:.9rem;letter-spacing:.15em}
.modal-close{background:none;border:none;color:var(--gold-light);font-size:1.3rem;cursor:pointer;line-height:1;padding:0 4px}
.modal-body{padding:18px;display:flex;flex-direction:column;gap:11px}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-label{font-size:.67rem;color:var(--gold);letter-spacing:.1em}
.form-input,.form-select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:4px;font-family:'Noto Sans JP',sans-serif;font-size:.8rem;color:var(--ink);background:var(--cream);outline:none;transition:border-color var(--tr)}
.form-input:focus,.form-select:focus{border-color:var(--gold)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.modal-foot{padding:12px 18px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.btn-cancel{padding:8px 16px;background:var(--cream-3);border:1px solid var(--border);border-radius:4px;font-family:'Noto Sans JP',sans-serif;font-size:.74rem;cursor:pointer;color:var(--ink-mid)}
.btn-register{padding:8px 18px;background:var(--teal);color:white;border:none;border-radius:4px;font-family:'Noto Sans JP',sans-serif;font-size:.74rem;font-weight:500;cursor:pointer;transition:var(--tr)}
.btn-register:hover{background:var(--teal-light)}
.btn-register:disabled{opacity:.6;cursor:not-allowed}

/* SIDEBAR OVERLAY */
.sidebar-overlay{display:none;position:fixed;inset:0;z-index:199;background:rgba(20,14,8,.55)}
.sidebar-overlay.show{display:block}

/* RESPONSIVE */
@media(min-width:768px){
  .header-staff{display:block}
  .hamburger{display:none}
  .sidebar{position:static}
  .sidebar-overlay{display:none !important}
  .karte-scroll{padding:22px}
}
@media(max-width:767px){
  .sidebar{position:fixed;top:52px;left:0;bottom:0;z-index:200;width:78vw;max-width:300px;transform:translateX(-100%);box-shadow:var(--shadow-lg)}
  .sidebar.open{transform:translateX(0)}
  .info-grid{grid-template-columns:1fr}
  .info-col{border-right:none;border-bottom:1px solid var(--border)}
  .info-col:last-child{border-bottom:none}
  .body-area{flex-direction:column;align-items:center}
  .voice-panel-inner{flex-wrap:wrap}
  .voice-input-area{width:100%;order:-1}
  .voice-btns{flex-direction:row;width:100%}
  .vbtn{flex:1;text-align:center}
  .mic-wrap{flex-direction:row;gap:10px}
  .form-row{grid-template-columns:1fr}
}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<!-- æ–°è¦æ‚£è€…ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-head">
      <span>æ–°è¦æ‚£è€…ã‚’ç™»éŒ²</span>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">æ°å *</label>
          <input class="form-input" id="f-name" type="text" placeholder="å±±ç”° å¤ªéƒ">
        </div>
        <div class="form-group">
          <label class="form-label">æ€§åˆ¥ *</label>
          <select class="form-select" id="f-gender">
            <option value="">é¸æŠ</option>
            <option value="ç”·æ€§">ç”·æ€§</option>
            <option value="å¥³æ€§">å¥³æ€§</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ç”Ÿå¹´æœˆæ—¥</label>
          <input class="form-input" id="f-birth" type="date">
        </div>
        <div class="form-group">
          <label class="form-label">é›»è©±ç•ªå·</label>
          <input class="form-input" id="f-phone" type="tel" placeholder="090-0000-0000">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ä½æ‰€</label>
        <input class="form-input" id="f-address" type="text" placeholder="æ±äº¬éƒ½ã€‡ã€‡åŒº...">
      </div>
      <div class="form-group">
        <label class="form-label">è·æ¥­</label>
        <input class="form-input" id="f-occupation" type="text" placeholder="ä¼šç¤¾å“¡ãƒ»ä¸»å©¦ãªã©">
      </div>
      <div class="form-group">
        <label class="form-label">æ—¢å¾€æ­´ãƒ»ç‰¹è¨˜äº‹é …</label>
        <input class="form-input" id="f-history" type="text" placeholder="é«˜è¡€åœ§ãƒ»æ‰‹è¡“æ­´ãªã©ï¼ˆãªã‘ã‚Œã°ç©ºæ¬„ï¼‰">
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-register" id="btnRegister" onclick="registerPatient()">ç™»éŒ²ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header class="top-header">
  <div class="header-logo" id="headerLogo">ã‚«ãƒ«ãƒ†</div>
  <div class="header-right">
    <div class="header-staff" id="headerStaff"></div>
    <button class="hamburger" onclick="toggleMenu()" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
      <span></span><span></span><span></span>
    </button>
  </div>
</header>

<div class="sidebar-overlay" id="overlay" onclick="closeMenu()"></div>

<div class="app-layout">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-inner">
      <div>
        <div class="sidebar-label">æ‚£è€…ä¸€è¦§</div>
        <div id="patientList" style="display:flex;flex-direction:column;gap:6px">
          <div style="font-size:.72rem;color:var(--ink-soft);padding:8px 4px">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        <button class="new-btn" onclick="openModal()">ï¼‹ æ–°è¦æ‚£è€…ã‚’ç™»éŒ²</button>
      </div>
      <div>
        <div class="sidebar-label">æ¥é™¢å±¥æ­´</div>
        <div class="history-list" id="historyList">
          <div style="font-size:.7rem;color:var(--ink-soft);padding:6px 4px">æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>
      </div>
    </div>
  </aside>

  <div class="main-area">
    <div class="karte-scroll fade-in">
      <div class="karte-card">
        <div class="karte-top">
          <div>
            <div class="karte-tag">Medical Chart</div>
            <div class="karte-salon" id="karteSalon">é™¢å</div>
          </div>
          <div class="karte-top-right">
            <div class="karte-no" id="karteNo">No. ----</div>
            <div class="karte-date" id="karteDate"></div>
          </div>
        </div>
        <div class="info-grid">
          <div class="info-col">
            <div class="info-row"><div class="lbl">æ°å</div><div class="val name-val" id="kName">â€”</div></div>
            <div class="info-row"><div class="lbl">ç”Ÿå¹´æœˆæ—¥</div><div class="val" id="kBirth">â€”</div></div>
            <div class="info-row"><div class="lbl">æ€§åˆ¥</div><div class="val" id="kGender">â€”</div></div>
            <div class="info-row"><div class="lbl">è·æ¥­</div><div class="val" id="kOccupation">â€”</div></div>
          </div>
          <div class="info-col">
            <div class="info-row"><div class="lbl">é›»è©±</div><div class="val" id="kPhone">â€”</div></div>
            <div class="info-row"><div class="lbl">ä½æ‰€</div><div class="val" id="kAddress">â€”</div></div>
            <div class="info-row"><div class="lbl">æ¥é™¢å›æ•°</div><div class="val" id="kVisitCount">â€”</div></div>
            <div class="info-row"><div class="lbl">æ‹…å½“è€…</div><div class="val" id="kTherapist">â€”</div></div>
          </div>
        </div>
        <div class="karte-section">
          <div class="section-head">ä¸»è¨´ãƒ»æ¥é™¢ç†ç”±</div>
          <div class="sec-body" id="kChief" style="color:var(--ink-soft)">æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>
        <div class="karte-section">
          <div class="section-head">ç—‡çŠ¶éƒ¨ä½</div>
          <div class="body-area">
            <div class="body-svg-wrap">
              <svg viewBox="0 0 80 200" xmlns="http://www.w3.org/2000/svg">
                <ellipse cx="40" cy="22" rx="12" ry="14" fill="none" stroke="#c4b08a" stroke-width="1.5"/>
                <rect x="22" y="36" width="36" height="42" rx="5" fill="none" stroke="#c4b08a" stroke-width="1.5"/>
                <line x1="22" y1="40" x2="6" y2="82" stroke="#c4b08a" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="58" y1="40" x2="74" y2="82" stroke="#c4b08a" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="30" y1="78" x2="26" y2="140" stroke="#c4b08a" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="50" y1="78" x2="54" y2="140" stroke="#c4b08a" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="26" y1="140" x2="22" y2="190" stroke="#c4b08a" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="54" y1="140" x2="58" y2="190" stroke="#c4b08a" stroke-width="1.5" stroke-linecap="round"/>
                <g id="painMarkers"></g>
              </svg>
            </div>
            <div class="pain-info">
              <div style="font-size:.65rem;color:var(--ink-soft);margin-bottom:6px;letter-spacing:.08em">è¨˜éŒ²ã•ã‚ŒãŸç—‡çŠ¶éƒ¨ä½</div>
              <div id="painTags"><span style="font-size:.72rem;color:var(--ink-soft)">â€”</span></div>
              <div class="pain-detail" id="painDetail"></div>
            </div>
          </div>
        </div>
        <div class="karte-section">
          <div class="section-head">æœ¬æ—¥ã®æ–½è¡“è¨˜éŒ²</div>
          <div id="visitRecordArea">
            <div class="no-record">æ‚£è€…ã‚’é¸æŠå¾Œã€éŸ³å£°å…¥åŠ›ã—ã¦ä¿å­˜ã™ã‚‹ã¨æ–½è¡“è¨˜éŒ²ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>
        </div>
      </div>
    </div>

    <!-- éŸ³å£°å…¥åŠ›ãƒ‘ãƒãƒ« -->
    <div class="voice-panel">
      <div class="voice-panel-inner">
        <div class="mic-wrap">
          <button class="mic-btn" id="micBtn" onclick="toggleMic()">
            <svg viewBox="0 0 24 24"><path d="M12 1a4 4 0 0 1 4 4v6a4 4 0 0 1-8 0V5a4 4 0 0 1 4-4zm-7 10a7 7 0 0 0 14 0h2a9 9 0 0 1-8 8.94V22h-2v-2.06A9 9 0 0 1 3 11h2z"/></svg>
          </button>
          <div class="mic-label" id="micLabel">éŒ²éŸ³é–‹å§‹</div>
        </div>
        <div class="voice-input-area">
          <textarea class="voice-textarea" id="voiceText" placeholder="ãƒã‚¤ã‚¯ã‚’ã‚¿ãƒƒãƒ— â†’ è©±ã™ã ã‘ã§ã‚«ãƒ«ãƒ†ã«è¨˜éŒ²&#10;ä¾‹ï¼šã€Œè…°ã®å³å´ãŒ7ç‚¹ãã‚‰ã„ã®ç—›ã¿ã€æ˜¨æ—¥ã‹ã‚‰æ‚ªåŒ–ã—ãŸã€"></textarea>
          <div class="voice-hint">ğŸ’¡ Web Speech API ä½¿ç”¨ï¼ˆç„¡æ–™ï¼‰</div>
        </div>
        <div class="voice-btns">
          <button class="vbtn vbtn-parse" onclick="parseVoice()">ğŸ¤– AIè§£æ</button>
          <button class="vbtn vbtn-save" onclick="saveGAS()">ğŸ“Š ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// =====================================================
// â–¼â–¼â–¼ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¨­å®šï¼ˆã“ã“ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰â–¼â–¼â–¼
// =====================================================
const CONFIG = {
  salonName: 'ã‚„ã™ã‚‰ãæ•´ä½“é™¢',  // â† é™¢åã‚’ã“ã“ã«å…¥åŠ›
  therapist: 'ç”°ä¸­ èŠ±å­',       // â† æ‹…å½“è€…åã‚’ã“ã“ã«å…¥åŠ›
  gasUrl: 'https://script.google.com/macros/s/AKfycbynwh9DJp2_kpU2ZS_hLkvt4fSwyfn7fMldIQUZR8JKA-PKbaek7SzVLBWmBQbN7Cxl/exec',
};
// =====================================================
// â–²â–²â–² ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¨­å®šã“ã“ã¾ã§ â–²â–²â–²
// =====================================================

const PART_MAP = {
  'é ­éƒ¨':{cx:40,cy:22},'é ¸éƒ¨':{cx:40,cy:36},'è‚©':{cx:58,cy:42},
  'èƒŒéƒ¨':{cx:40,cy:55},'è…°éƒ¨':{cx:40,cy:70},'éª¨ç›¤':{cx:40,cy:82},
  'è‚¡é–¢ç¯€':{cx:52,cy:90},'å¤§è…¿éƒ¨':{cx:48,cy:108},'è†é–¢ç¯€':{cx:50,cy:120},
  'ä¸‹è…¿éƒ¨':{cx:52,cy:140},'è¶³é–¢ç¯€':{cx:56,cy:160},
  'è‚˜é–¢ç¯€':{cx:70,cy:65},'æ‰‹é–¢ç¯€':{cx:74,cy:80},
};

let state = {patients:[], selectedId:null, lastParsed:null};

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('headerLogo').textContent = CONFIG.salonName + ' ã‚«ãƒ«ãƒ†';
  document.getElementById('headerStaff').textContent = 'æ–½è¡“è€…ï¼š' + CONFIG.therapist;
  document.getElementById('karteSalon').textContent = CONFIG.salonName;
  document.getElementById('kTherapist').textContent = CONFIG.therapist;
  document.title = CONFIG.salonName + ' ã‚«ãƒ«ãƒ†';
  const d = new Date();
  document.getElementById('karteDate').textContent =
    d.getFullYear()+'å¹´'+(d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥ï¼ˆ'+'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()]+'ï¼‰';
  loadPatients();
});

async function loadPatients() {
  const el = document.getElementById('patientList');
  try {
    const res = await fetch(CONFIG.gasUrl, {
      method:'POST', headers:{'Content-Type':'text/plain'},
      body: JSON.stringify({action:'getPatients'}),
    });
    const data = await res.json();
    if (data.success && data.patients && data.patients.length > 0) {
      state.patients = data.patients;
      renderPatientList(data.patients);
    } else {
      el.innerHTML = '<div style="font-size:.72rem;color:var(--ink-soft);padding:8px 4px;line-height:1.8">æ‚£è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€Œæ–°è¦æ‚£è€…ã‚’ç™»éŒ²ã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
    }
  } catch(e) {
    el.innerHTML = '<div style="font-size:.72rem;color:var(--ink-soft);padding:8px 4px;line-height:1.8">ã€Œæ–°è¦æ‚£è€…ã‚’ç™»éŒ²ã€ã‹ã‚‰<br>æ‚£è€…ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
  }
}

function renderPatientList(patients) {
  const el = document.getElementById('patientList');
  const colors = ['var(--ink)','#2d6a6a','#5a4030','#3a4a60','#4a3060'];
  el.innerHTML = '';
  patients.forEach((p, i) => {
    const ch = (p.name||'æ‚£').replace(/\s/g,'').charAt(0);
    const div = document.createElement('div');
    div.className = 'patient-item' + (i===0?' active':'');
    div.dataset.id = p.id;
    div.innerHTML = `
      <div class="patient-avatar" style="background:${colors[i%colors.length]};color:var(--gold)">${ch}</div>
      <div>
        <div class="p-name">${p.name||'åå‰ãªã—'}</div>
        <div class="p-meta">${p.gender||''}${p.visitCount>0?'ã€€'+p.visitCount+'å›':''}</div>
      </div>`;
    div.onclick = () => selectPatient(p.id);
    el.appendChild(div);
  });
  if (patients.length > 0) selectPatient(patients[0].id);
}

function selectPatient(id) {
  state.selectedId = id;
  document.querySelectorAll('.patient-item').forEach(el => el.classList.toggle('active', el.dataset.id===id));
  const p = state.patients.find(p=>p.id===id);
  if (!p) return;
  document.getElementById('karteNo').textContent = 'No. ' + (id||'----');
  document.getElementById('kName').textContent = p.name||'â€”';
  document.getElementById('kBirth').textContent = p.birthdate ? formatDate(p.birthdate) : 'â€”';
  document.getElementById('kGender').textContent = p.gender||'â€”';
  document.getElementById('kOccupation').textContent = p.occupation||'â€”';
  document.getElementById('kPhone').textContent = p.phone||'â€”';
  document.getElementById('kAddress').textContent = p.address||'â€”';
  document.getElementById('kVisitCount').textContent = p.visitCount ? p.visitCount+'å›' : 'åˆå›';
  const chief = document.getElementById('kChief');
  chief.textContent = 'éŸ³å£°å…¥åŠ› â†’ AIè§£æ â†’ ä¿å­˜ ã§è¨˜éŒ²ã•ã‚Œã¾ã™';
  chief.style.color = 'var(--ink-soft)';
  document.getElementById('painTags').innerHTML = '<span style="font-size:.72rem;color:var(--ink-soft)">â€”</span>';
  document.getElementById('painDetail').innerHTML = '';
  document.getElementById('painMarkers').innerHTML = '';
  document.getElementById('visitRecordArea').innerHTML = '<div class="no-record">éŸ³å£°å…¥åŠ›ã—ã¦ä¿å­˜ã™ã‚‹ã¨æ–½è¡“è¨˜éŒ²ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>';
  state.lastParsed = null;
  closeMenu();
}

function openModal()  { document.getElementById('modalOverlay').classList.add('open'); }
function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  ['f-name','f-gender','f-birth','f-phone','f-address','f-occupation','f-history'].forEach(id=>{
    document.getElementById(id).value='';
  });
}

async function registerPatient() {
  const name = document.getElementById('f-name').value.trim();
  if (!name) { alert('æ°åã¯å¿…é ˆã§ã™'); return; }
  const btn = document.getElementById('btnRegister');
  btn.textContent='ç™»éŒ²ä¸­...'; btn.disabled=true;
  const payload = {
    action:'newPatient', name,
    gender:     document.getElementById('f-gender').value,
    birthdate:  document.getElementById('f-birth').value,
    phone:      document.getElementById('f-phone').value.trim(),
    address:    document.getElementById('f-address').value.trim(),
    occupation: document.getElementById('f-occupation').value.trim(),
    history:    document.getElementById('f-history').value.trim(),
  };
  try {
    await fetch(CONFIG.gasUrl, {
      method:'POST', headers:{'Content-Type':'text/plain'},
      body:JSON.stringify(payload), mode:'no-cors',
    });
    const newId = 'P' + String(state.patients.length+1).padStart(4,'0');
    state.patients.push({...payload, id:newId, visitCount:0});
    renderPatientList(state.patients);
    selectPatient(newId);
    closeModal();
    alert('âœ… '+name+' ã•ã‚“ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œæ‚£è€…ãƒã‚¹ã‚¿ã€ã‚·ãƒ¼ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚');
  } catch(e) {
    alert('ç™»éŒ²ã‚¨ãƒ©ãƒ¼ï¼š'+e.message);
  } finally {
    btn.textContent='ç™»éŒ²ã™ã‚‹'; btn.disabled=false;
  }
}

let isRec=false, recognition=null, demoTimer=null;

function toggleMic() {
  isRec = !isRec;
  const btn=document.getElementById('micBtn'), lbl=document.getElementById('micLabel');
  if (isRec) {
    btn.classList.add('rec'); lbl.textContent='éŒ²éŸ³ä¸­...';
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang='ja-JP'; recognition.continuous=true; recognition.interimResults=true;
      recognition.onresult = e => {
        let t='';
        for(let i=e.resultIndex;i<e.results.length;i++) t+=e.results[i][0].transcript;
        document.getElementById('voiceText').value=t;
      };
      recognition.onerror = () => stopMic();
      recognition.start();
    } else {
      demoTimer = setTimeout(()=>{
        document.getElementById('voiceText').value='ä»Šæ—¥ã¯è…°ã®å³å´ãŒç—›ã„ã¨ãŠã£ã—ã‚ƒã£ã¦ã„ã¾ã™ã€‚ç—›ã¿ã¯7ç‚¹ãã‚‰ã„ã€‚å…ˆé€±ã‹ã‚‰æ‚ªåŒ–ã—ã¦ã„ã¦ã€é•·æ™‚é–“åº§ã£ã¦ã„ã‚‹ã¨ç‰¹ã«ã¤ã‚‰ã„ã€‚';
      }, 2000);
    }
  } else { stopMic(); }
}

function stopMic() {
  isRec=false;
  const btn=document.getElementById('micBtn'), lbl=document.getElementById('micLabel');
  btn.classList.remove('rec'); lbl.textContent='éŒ²éŸ³å®Œäº† âœ“';
  setTimeout(()=>{lbl.textContent='éŒ²éŸ³é–‹å§‹';},3000);
  if(recognition){recognition.stop();recognition=null;}
  if(demoTimer){clearTimeout(demoTimer);demoTimer=null;}
}

function localParse(text) {
  const dict=[
    {k:'è…°',l:'è…°éƒ¨'},{k:'è‚©',l:'è‚©'},{k:'é¦–',l:'é ¸éƒ¨'},{k:'é ¸',l:'é ¸éƒ¨'},
    {k:'èƒŒä¸­',l:'èƒŒéƒ¨'},{k:'è‚¡é–¢ç¯€',l:'è‚¡é–¢ç¯€'},{k:'è†',l:'è†é–¢ç¯€'},
    {k:'è¶³é¦–',l:'è¶³é–¢ç¯€'},{k:'æ‰‹é¦–',l:'æ‰‹é–¢ç¯€'},{k:'è‚˜',l:'è‚˜é–¢ç¯€'},
    {k:'é ­',l:'é ­éƒ¨'},{k:'éª¨ç›¤',l:'éª¨ç›¤'},{k:'ãµãã‚‰ã¯ã',l:'ä¸‹è…¿éƒ¨'},{k:'å¤ªã‚‚ã‚‚',l:'å¤§è…¿éƒ¨'},
  ];
  const parts=[];
  dict.forEach(({k,l})=>{if(text.includes(k)&&!parts.includes(l))parts.push(l);});
  const m=text.match(/([0-9ï¼-ï¼™]+)\s*[ç‚¹\/]/);
  const level=m?m[1].replace(/[ï¼-ï¼™]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0)):null;
  return {painParts:parts, painLevel:level, chiefComplaint:text};
}

function parseVoice() {
  const text=document.getElementById('voiceText').value.trim();
  if(!text){alert('ã¾ãšéŒ²éŸ³ã—ã¦ãã ã•ã„');return;}
  const parsed=localParse(text);
  state.lastParsed=parsed;
  document.getElementById('painTags').innerHTML = parsed.painParts.length
    ? parsed.painParts.map(p=>`<span class="pain-tag">${p}</span>`).join('')
    : '<span style="font-size:.72rem;color:var(--ink-soft)">éƒ¨ä½ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</span>';
  document.getElementById('painDetail').innerHTML = parsed.painLevel
    ? `ç—›ã¿ãƒ¬ãƒ™ãƒ«ï¼š<strong style="color:var(--red)">${parsed.painLevel} / 10</strong>`
    : 'ç—›ã¿ãƒ¬ãƒ™ãƒ«ï¼šè¨˜è¼‰ãªã—';
  document.getElementById('painMarkers').innerHTML = parsed.painParts
    .filter(p=>PART_MAP[p])
    .map(p=>`<circle cx="${PART_MAP[p].cx}" cy="${PART_MAP[p].cy}" r="7" fill="rgba(176,48,48,0.2)" stroke="#b03030" stroke-width="1.5"/>`)
    .join('');
  const chief=document.getElementById('kChief');
  chief.textContent=text; chief.style.color='var(--ink)';
  document.getElementById('micLabel').textContent='è§£æå®Œäº† âœ“';
  setTimeout(()=>{document.getElementById('micLabel').textContent='éŒ²éŸ³é–‹å§‹';},2000);
}

async function saveGAS() {
  const text=document.getElementById('voiceText').value.trim();
  if(!text){alert('éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');return;}
  if(!state.selectedId){alert('æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  const lbl=document.getElementById('micLabel');
  lbl.textContent='ä¿å­˜ä¸­...';
  const parsed=state.lastParsed||localParse(text);
  const p=state.patients.find(p=>p.id===state.selectedId);
  try {
    await fetch(CONFIG.gasUrl, {
      method:'POST', headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({
        action:'saveVisit', patientId:state.selectedId,
        therapist:CONFIG.therapist, chiefComplaint:parsed.chiefComplaint,
        painLevel:parsed.painLevel||'', painParts:parsed.painParts.join('ãƒ»'),
        findings:'', treatment:'', afterState:'', nextNote:'', voiceText:text,
      }), mode:'no-cors',
    });
    const newCount=(p?(Number(p.visitCount)||0):0)+1;
    if(p) p.visitCount=newCount;
    document.getElementById('kVisitCount').textContent=newCount+'å›';
    const now=new Date();
    const timeStr=now.getHours()+':'+String(now.getMinutes()).padStart(2,'0');
    document.getElementById('visitRecordArea').innerHTML=`
      <div class="visit-box" style="margin-top:10px">
        <div class="visit-head">
          <span>æ–½è¡“è¨˜éŒ²</span>
          <span>${now.getFullYear()}.${now.getMonth()+1}.${now.getDate()} ${timeStr}</span>
        </div>
        <div class="visit-body">
          <div class="vrow"><span class="vlbl">æœ¬æ—¥ã®è¨´ãˆ</span><span>${text}</span></div>
          <div class="vrow"><span class="vlbl">ç—‡çŠ¶éƒ¨ä½</span><span>${parsed.painParts.join('ãƒ»')||'â€”'}</span></div>
          <div class="vrow"><span class="vlbl">ç—›ã¿ãƒ¬ãƒ™ãƒ«</span><span>${parsed.painLevel?parsed.painLevel+'/10':'â€”'}</span></div>
          <div class="vrow"><span class="vlbl">æ‹…å½“è€…</span><span>${CONFIG.therapist}</span></div>
        </div>
      </div>`;
    lbl.textContent='ä¿å­˜å®Œäº† âœ“';
    setTimeout(()=>{lbl.textContent='éŒ²éŸ³é–‹å§‹';},3000);
    document.getElementById('voiceText').value='';
    state.lastParsed=null;
    alert('ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸï¼\n\næ‚£è€…ï¼š'+(p?p.name:'')+'\nç—‡çŠ¶ï¼š'+(parsed.painParts.join('ãƒ»')||'æœªæ¤œå‡º')+'\n\nã€Œæ¥é™¢è¨˜éŒ²ã€ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  } catch(e) {
    lbl.textContent='éŒ²éŸ³é–‹å§‹';
    alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š'+e.message);
  }
}

function formatDate(s) {
  if(!s) return 'â€”';
  const d=new Date(s);
  if(isNaN(d)) return s;
  const age=Math.floor((new Date()-d)/(365.25*24*60*60*1000));
  return d.getFullYear()+'å¹´'+(d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥ï¼ˆ'+age+'æ­³ï¼‰';
}
function toggleMenu(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('show');
}
function closeMenu(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('show');
}
</script>
</body>
</html>
